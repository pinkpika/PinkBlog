<!DOCTYPE html><html lang="zh-TW" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>iOS Web API 設計 (Web API Design in iOS) | Pink Blog</title><meta name="keywords" content="iOS,Web API"><meta name="author" content="pinkpika,tim801217@gmail.com"><meta name="copyright" content="pinkpika"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="API 指的是應用程式之間溝通的介面，而本篇主題其實是前端呼叫後端 Web API 的設計，前端使用 Web API 可以拿到遠端的資料，也可依照不同用戶提供他們不同的內容，因此如何設計前端 Web API 層的邏輯變得很重要，需要兼具共用性和擴充性。   本篇所提及的 Web API 設計版本，其實是用來 紀錄自己曾經使用過的設計方式，未來也可能會再增加，所以內容有大量自身使用過的感想，不代表絕">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS Web API 設計 (Web API Design in iOS)">
<meta property="og:url" content="http://pinkpika.github.io/pinkblog/2022/02/17/iOS-Web-API-%E8%A8%AD%E8%A8%88-Web-API-Design-in-iOS/index.html">
<meta property="og:site_name" content="Pink Blog">
<meta property="og:description" content="API 指的是應用程式之間溝通的介面，而本篇主題其實是前端呼叫後端 Web API 的設計，前端使用 Web API 可以拿到遠端的資料，也可依照不同用戶提供他們不同的內容，因此如何設計前端 Web API 層的邏輯變得很重要，需要兼具共用性和擴充性。   本篇所提及的 Web API 設計版本，其實是用來 紀錄自己曾經使用過的設計方式，未來也可能會再增加，所以內容有大量自身使用過的感想，不代表絕">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="http://pinkpika.github.io/pinkblog/2022/02/17/iOS-Web-API-%E8%A8%AD%E8%A8%88-Web-API-Design-in-iOS/unsplash_ZiQkhI7417A.jpg">
<meta property="article:published_time" content="2022-02-17T03:05:18.000Z">
<meta property="article:modified_time" content="2022-02-28T05:21:01.109Z">
<meta property="article:author" content="pinkpika">
<meta property="article:tag" content="iOS">
<meta property="article:tag" content="Web API">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://pinkpika.github.io/pinkblog/2022/02/17/iOS-Web-API-%E8%A8%AD%E8%A8%88-Web-API-Design-in-iOS/unsplash_ZiQkhI7417A.jpg"><link rel="shortcut icon" href="/pinkblog/"><link rel="canonical" href="http://pinkpika.github.io/pinkblog/2022/02/17/iOS-Web-API-%E8%A8%AD%E8%A8%88-Web-API-Design-in-iOS/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/pinkblog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-J63BRH65VP"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-J63BRH65VP');
</script><script>const GLOBAL_CONFIG = { 
  root: '/pinkblog/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '複製成功',
    error: '複製錯誤',
    noSupport: '瀏覽器不支援'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '剛剛',
    min: '分鐘前',
    hour: '小時前',
    day: '天前',
    month: '個月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'iOS Web API 設計 (Web API Design in iOS)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2月 28 2022 13:21:01'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/pinkblog/atom.xml" title="Pink Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/pinkblog/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/pinkblog/archives/"><div class="headline">文章</div><div class="length-num">21</div></a></div><div class="data-item"><a href="/pinkblog/tags/"><div class="headline">標籤</div><div class="length-num">13</div></a></div><div class="data-item"><a href="/pinkblog/categories/"><div class="headline">分類</div><div class="length-num">6</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/pinkblog/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/pinkblog/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/pinkblog/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/pinkblog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/pinkblog/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Other</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/pinkblog/song/"><i class="fa-fw fas fa-music"></i><span> Song</span></a></li><li><a class="site-page child" href="/pinkblog/mind/"><i class="fa-fw fas fa-heart"></i><span> Mind</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/pinkblog/about/"><i class="fa-fw fas fa-user"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/pinkblog/2022/02/17/iOS-Web-API-%E8%A8%AD%E8%A8%88-Web-API-Design-in-iOS/unsplash_ZiQkhI7417A.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/pinkblog/">Pink Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/pinkblog/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/pinkblog/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/pinkblog/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/pinkblog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/pinkblog/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Other</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/pinkblog/song/"><i class="fa-fw fas fa-music"></i><span> Song</span></a></li><li><a class="site-page child" href="/pinkblog/mind/"><i class="fa-fw fas fa-heart"></i><span> Mind</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/pinkblog/about/"><i class="fa-fw fas fa-user"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">iOS Web API 設計 (Web API Design in iOS)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">發表於</span><time class="post-meta-date-created" datetime="2022-02-17T03:05:18.000Z" title="發表於 2月 17 2022 11:05:18">2月 17 2022</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新於</span><time class="post-meta-date-updated" datetime="2022-02-28T05:21:01.109Z" title="更新於 2月 28 2022 13:21:01">2月 28 2022</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/pinkblog/categories/iOS-Development/">iOS Development</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="iOS Web API 設計 (Web API Design in iOS)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">閱讀量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="note default flat"><p>API 指的是應用程式之間溝通的介面，而本篇主題其實是前端呼叫後端 Web API 的設計，前端使用 Web API 可以拿到遠端的資料，也可依照不同用戶提供他們不同的內容，因此如何設計前端 Web API 層的邏輯變得很重要，需要兼具共用性和擴充性。</p>
</div>

<div class="note warning flat"><p>本篇所提及的 Web API 設計版本，其實是用來 <strong>紀錄自己曾經使用過的設計方式</strong>，未來也可能會再增加，所以內容有大量自身使用過的感想，<strong>不代表絕對的好壞，依照專案需求或架構會有更適合的設計方式</strong>。</p>
</div>

<h1 id="Web-API-設計的邏輯"><a href="#Web-API-設計的邏輯" class="headerlink" title="Web API 設計的邏輯"></a>Web API 設計的邏輯</h1><p>在實作 Web API 層的邏輯前，可以把它分成三段流程</p>
<img src="/pinkblog/2022/02/17/iOS-Web-API-%E8%A8%AD%E8%A8%88-Web-API-Design-in-iOS/0.png" class="" width="300">

<h2 id="🔵-Part1-組合-Request-流程"><a href="#🔵-Part1-組合-Request-流程" class="headerlink" title="🔵 Part1 組合 Request 流程"></a>🔵 Part1 組合 Request 流程</h2><ul>
<li>如何組成 Request ?<ul>
<li>發送前需要設定好各項參數，可能包含有下列項目</li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/URL_API">URL</a>: 請求的網址，包含 scheme、host、 port、path、query … 等等<ul>
<li>ex. <code>https://www.ios.com/api/user?id=9999&amp;type=1</code></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods">HTTP method</a>: 請求的方法，通常能反應出此 API 的目的<ul>
<li>ex. get、post、put、patch、delete ….</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers">HTTP header</a>: 請求的附加資料，有很多種已經定好的規範、也可以自訂資料<ul>
<li>ex. Content-Type: application/x-www-form-urlencoded</li>
<li>ex. Content-Type: application/json</li>
<li>ex. Authorization: Bearer …. =&gt; 身份驗證用</li>
<li>ex. Accept-Language: zh-TW =&gt; 指定語言用</li>
<li>ex. Tracing: …. =&gt; 客製化追蹤</li>
</ul>
</li>
<li>Body: 依照不同的 Content-Type 會塞不同的 Body<ul>
<li>ex. “action=getmemberdata&amp;id=111”.data(using: .utf8)</li>
<li>ex. “{&quot;action&quot;: &quot;getlatestposts&quot;,&quot;fetchcount&quot;: 20 }”.data(using: .utf8)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="🔴-Part2-發送-API-流程"><a href="#🔴-Part2-發送-API-流程" class="headerlink" title="🔴 Part2 發送 API 流程"></a>🔴 Part2 發送 API 流程</h2><ul>
<li>使用什麼發送 API ?<ul>
<li>通常使用 <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/urlsession">URLSession</a> 或是使用 <a target="_blank" rel="noopener" href="https://github.com/Alamofire/Alamofire">Alamofire</a></li>
<li>選擇發送 Task 類型，一般 API 快速交握請求會使用 dataTask，此外 uploadTask、downloadTask 是用於長時間上傳或下載且可在背景執行。</li>
</ul>
</li>
<li>如何設定網路 Config ?<ul>
<li>怎麼處理網路層的邏輯封包、網路交握都被底層封裝了，只能設定一些通用屬性、Cookie、Cache 等等，可參考 <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/urlsessionconfiguration">URLSessionConfiguration</a></li>
<li>值得注意的是 URLSession 對相同 host 並發 Request 是有上限的，如果有特殊需求需要調整，可參考 <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/urlsessionconfiguration/1407597-httpmaximumconnectionsperhost">httpMaximumConnectionsPerHost</a></li>
<li>取得 task 進度，需要實作 <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/urlsessiontaskdelegate">URLSessionTaskDelegate</a></li>
<li>取得狀態 task.state </li>
<li>強制取消 task.cancel (polling/long-polling可能會用到)</li>
</ul>
</li>
<li>如何接收回應 ?<ul>
<li>一種是使用 callback closure 的方式觸發</li>
<li>另一種就是 Swift 5.5 URLSession 開始支援 async await 的方式，寫起來更直觀更方便</li>
</ul>
</li>
<li>記得要注意 API 回來的 thread 是在哪裡 ?<ul>
<li>URLSession 的 dataTask callback 預設是 background thread</li>
<li>URLSession 的 async await 是回發送前的 thread</li>
<li>Alamofire callback 預設是 main thread</li>
</ul>
</li>
</ul>
<h2 id="🟢-Part3-處理-Response-流程"><a href="#🟢-Part3-處理-Response-流程" class="headerlink" title="🟢 Part3 處理 Response 流程"></a>🟢 Part3 處理 Response 流程</h2><ul>
<li>收到回應該如何處理 ?<ul>
<li>URLSession 回應通常會收到三個物件 Data、URLResponse、Error 皆為 optional<ul>
<li><code>dataTask(with request: URLRequest, completionHandler: @escaping (Data?, URLResponse?, Error?) -&gt; Void)</code></li>
</ul>
</li>
<li>通常先處理 <strong>Error</strong>，如果有值就是網路層就遇到問題</li>
<li>其次可以判斷 <strong>URLResponse 內的 statusCode</strong>，如果符合規範的 API 設計可以從 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">HTTP statusCode</a> 判斷狀態<ul>
<li><code>(response as? HTTPURLResponse)?.statusCode</code></li>
<li>2XX 成功回應 </li>
<li>3XX 重新轉向的回應</li>
<li>4XX 用戶端的錯誤 =&gt; 400 無效請求、401 授權失敗 … </li>
<li>5XX 伺服器端錯誤 =&gt; 500 伺服器端內部未知錯誤 …</li>
</ul>
</li>
<li>最後要將 <strong>Data</strong> 轉換成預期的物件，有可能是後台定義好的回應物件或是錯誤物件</li>
</ul>
</li>
<li>如果發生錯誤，是否需要重試 ?</li>
<li>如果發生用戶沒有網路，如何通知用戶 ?</li>
<li>如果發生授權失敗或過期，是否需要自動重刷 token 或是通知畫面 ?</li>
</ul>
<p>上面三個部分也可能會加入 Debug Log 或是事件追蹤，當頁面的不同、用戶操作的不同、站台的不同也會進行不同的設定。<br>下面來試試看進行 Web API 的邏輯封裝和重複利用，每個版本都會示範 Get、Post+UrlEncoded、Post+Json，如果需要其他 method 可以自行新增。</p>
<hr>
<h1 id="Version1-：使用物件和方法封裝"><a href="#Version1-：使用物件和方法封裝" class="headerlink" title="[Version1]：使用物件和方法封裝"></a>[Version1]：使用物件和方法封裝</h1><h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li>使用單一或多個 Manager 封裝呼叫 API 的方法和處理方式，也是實作難度最低的</li>
<li>至少能確保呼叫 API 邏輯或三方依賴都可以鎖在 Manager 內部</li>
<li>每一道方法都是呼叫一道 API 自行實作 Part1、Part2、Part3，確保職責的單一性，理論上互相不干擾<ul>
<li>ex. <code>requestHttpBinGet</code>、<code>requestHttpBinPostUrlEncoded</code>、<code>requestHttpBinPostJson</code></li>
</ul>
</li>
<li>封裝共用的邏輯，像是解析回應物件、組裝 Header 等等<ul>
<li>ex. <code>handleResponse</code>、<code>addHeaderContentTypeJson</code>、<code>addHeaderContentTypeURLEncoded</code></li>
</ul>
</li>
</ul>
<img src="/pinkblog/2022/02/17/iOS-Web-API-%E8%A8%AD%E8%A8%88-Web-API-Design-in-iOS/1.png" class="" width="600">

<h2 id="實作範例"><a href="#實作範例" class="headerlink" title="實作範例"></a>實作範例</h2><div class="tabs" id="version1"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#version1-1">APIManager</button></li><li class="tab"><button type="button" data-href="#version1-2">APIManager+HttpBinGet</button></li><li class="tab"><button type="button" data-href="#version1-3">APIManager+HttpBinPostUrlEncoded</button></li><li class="tab"><button type="button" data-href="#version1-4">APIManager+HttpBinPostJson</button></li><li class="tab"><button type="button" data-href="#version1-5">URLRequest+AddHeader</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="version1-1"><figure class="highlight swift"><figcaption><span>APIManager.swift</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// API 管理者</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIManager</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> shared <span class="operator">=</span> <span class="type">APIManager</span>()</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">init</span>()</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 處理回應</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">handleResponse</span>&lt;<span class="type">T</span>: <span class="type">Decodable</span>&gt;(<span class="params">data</span>: <span class="type">Data</span>?, <span class="params">response</span>: <span class="type">URLResponse</span>?, <span class="params">error</span>: <span class="type">Error</span>?, <span class="params">completion</span>: <span class="keyword">@escaping</span> ((<span class="type">Result</span>&lt;<span class="type">T</span>,<span class="type">APIManagerError</span>&gt;) -&gt; <span class="type">Void</span>))</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> error <span class="operator">=</span> error&#123;</span><br><span class="line">            completion(.failure(.requestError(error: error)))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> statusCode <span class="operator">=</span> (response <span class="keyword">as?</span> <span class="type">HTTPURLResponse</span>)<span class="operator">?</span>.statusCode&#123;</span><br><span class="line">            <span class="built_in">print</span>(statusCode)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> data <span class="operator">=</span> data <span class="keyword">else</span> &#123;</span><br><span class="line">            completion(.failure(.nilData))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> response <span class="operator">=</span> <span class="keyword">try?</span> <span class="type">JSONDecoder</span>().decode(<span class="type">T</span>.<span class="keyword">self</span>, from: data) <span class="keyword">else</span> &#123;</span><br><span class="line">            completion(.failure(.decodeError))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        completion(.success(response))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: - 錯誤物件</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">APIManager</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 錯誤物件</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">APIManagerError</span>: <span class="title">Error</span></span>&#123;</span><br><span class="line">        <span class="keyword">case</span> requestError(error: <span class="type">Error</span>)</span><br><span class="line">        <span class="keyword">case</span> nilData</span><br><span class="line">        <span class="keyword">case</span> decodeError</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version1-2"><figure class="highlight swift"><figcaption><span>APIManager+HttpBinGet.swift</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">APIManager</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HttpBinGetResponse</span>: <span class="title">Codable</span></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Args</span>: <span class="title">Codable</span></span>&#123;</span><br><span class="line">            <span class="keyword">let</span> value: <span class="type">String</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> args: <span class="type">Args</span></span><br><span class="line">        <span class="keyword">let</span> origin: <span class="type">String</span></span><br><span class="line">        <span class="keyword">let</span> url: <span class="type">String</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">requestHttpBinGet</span>(<span class="params">value</span>: <span class="type">String</span>, <span class="params">completion</span>: <span class="keyword">@escaping</span> ((<span class="type">Result</span>&lt;<span class="type">HttpBinGetResponse</span>,<span class="type">APIManagerError</span>&gt;) -&gt; <span class="type">Void</span>))</span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Part1 組合 Request，使用方法或擴充封裝類似的邏輯</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://httpbin.org/get?value=<span class="subst">\(value)</span>&quot;</span>) <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        <span class="keyword">var</span> request <span class="operator">=</span> <span class="type">URLRequest</span>(url: url)</span><br><span class="line">        request.method <span class="operator">=</span> .get</span><br><span class="line">        request.addHeaderAuthToken()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Part2 發動 API，如果有需求也可抽換</span></span><br><span class="line">        <span class="keyword">let</span> dataTask <span class="operator">=</span> <span class="type">URLSession</span>.shared.dataTask(with: request) &#123;</span><br><span class="line">            data, response, error <span class="keyword">in</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Part3 處理 Response，使用方法或擴充封裝類似的邏輯</span></span><br><span class="line">            <span class="keyword">self</span>.handleResponse(data: data, response: response, error: error, completion: completion)</span><br><span class="line">        &#125;</span><br><span class="line">        dataTask.resume()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version1-3"><figure class="highlight swift"><figcaption><span>APIManager+HttpBinPostUrlEncoded.swift</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">APIManager</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HttpBinPostUrlEncodedResponse</span>: <span class="title">Codable</span></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Form</span>: <span class="title">Codable</span></span>&#123;</span><br><span class="line">            <span class="keyword">let</span> value: <span class="type">String</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> form: <span class="type">Form</span></span><br><span class="line">        <span class="keyword">let</span> origin: <span class="type">String</span></span><br><span class="line">        <span class="keyword">let</span> url: <span class="type">String</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">requestHttpBinPostUrlEncoded</span>(<span class="params">value</span>: <span class="type">String</span>, <span class="params">completion</span>: <span class="keyword">@escaping</span> ((<span class="type">Result</span>&lt;<span class="type">HttpBinPostUrlEncodedResponse</span>,<span class="type">APIManagerError</span>&gt;) -&gt; <span class="type">Void</span>))</span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Part1 組合 Request，使用方法或擴充封裝類似的邏輯</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://httpbin.org/post&quot;</span>) <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        <span class="keyword">var</span> request <span class="operator">=</span> <span class="type">URLRequest</span>(url: url)</span><br><span class="line">        request.method <span class="operator">=</span> .post</span><br><span class="line">        request.addHeaderAuthToken()</span><br><span class="line">        request.addHeaderContentTypeURLEncoded()</span><br><span class="line">        request.httpBody <span class="operator">=</span> <span class="string">&quot;value=<span class="subst">\(value)</span>&quot;</span>.data(using: .utf8)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Part2 發動 API，如果有需求也可抽換</span></span><br><span class="line">        <span class="keyword">let</span> dataTask <span class="operator">=</span> <span class="type">URLSession</span>.shared.dataTask(with: request) &#123;</span><br><span class="line">            data, response, error <span class="keyword">in</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Part3 處理 Response，使用方法或擴充封裝類似的邏輯</span></span><br><span class="line">            <span class="keyword">self</span>.handleResponse(data: data, response: response, error: error, completion: completion)</span><br><span class="line">        &#125;</span><br><span class="line">        dataTask.resume()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version1-4"><figure class="highlight swift"><figcaption><span>APIManager+HttpBinPostJson.swift</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">APIManager</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HttpBinPostJsonResponse</span>: <span class="title">Codable</span></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">JsonData</span>: <span class="title">Codable</span></span>&#123;</span><br><span class="line">            <span class="keyword">let</span> value: <span class="type">String</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> json: <span class="type">JsonData</span></span><br><span class="line">        <span class="keyword">let</span> origin: <span class="type">String</span></span><br><span class="line">        <span class="keyword">let</span> url: <span class="type">String</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">requestHttpBinPostJson</span>(<span class="params">value</span>: <span class="type">String</span>, <span class="params">completion</span>: <span class="keyword">@escaping</span> ((<span class="type">Result</span>&lt;<span class="type">HttpBinPostJsonResponse</span>,<span class="type">APIManagerError</span>&gt;) -&gt; <span class="type">Void</span>))</span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Part1 組合 Request，使用方法或擴充封裝類似的邏輯</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://httpbin.org/post&quot;</span>) <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        <span class="keyword">var</span> request <span class="operator">=</span> <span class="type">URLRequest</span>(url: url)</span><br><span class="line">        request.method <span class="operator">=</span> .post</span><br><span class="line">        request.addHeaderAuthToken()</span><br><span class="line">        request.addHeaderContentTypeJson()</span><br><span class="line">        request.httpBody <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;value&quot;: &quot;<span class="subst">\(value)</span>&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>.data(using: .utf8)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Part2 發動 API，如果有需求也可抽換</span></span><br><span class="line">        <span class="keyword">let</span> dataTask <span class="operator">=</span> <span class="type">URLSession</span>.shared.dataTask(with: request) &#123;</span><br><span class="line">            data, response, error <span class="keyword">in</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Part3 處理 Response，使用方法或擴充封裝類似的邏輯</span></span><br><span class="line">            <span class="keyword">self</span>.handleResponse(data: data, response: response, error: error, completion: completion)</span><br><span class="line">        &#125;</span><br><span class="line">        dataTask.resume()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version1-5"><figure class="highlight swift"><figcaption><span>URLRequest+AddHeader.swift</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">URLRequest</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">@discardableResult</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">addHeaderAuthToken</span>()</span> -&gt; <span class="type">URLRequest</span>&#123;</span><br><span class="line">        <span class="keyword">self</span>.addValue(<span class="string">&quot;Bearer ......&quot;</span>, forHTTPHeaderField: <span class="string">&quot;Authorization&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">@discardableResult</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">addHeaderContentTypeJson</span>()</span> -&gt; <span class="type">URLRequest</span>&#123;</span><br><span class="line">        <span class="keyword">self</span>.addValue(<span class="string">&quot;application/json&quot;</span>, forHTTPHeaderField: <span class="string">&quot;Content-Type&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">@discardableResult</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">addHeaderContentTypeURLEncoded</span>()</span> -&gt; <span class="type">URLRequest</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.addValue(<span class="string">&quot;application/x-www-form-urlencoded&quot;</span>, forHTTPHeaderField: <span class="string">&quot;Content-Type&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>

<h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">APIManager</span>.shared.requestHttpBinGet(value: <span class="string">&quot;xxxx1&quot;</span>) &#123;</span><br><span class="line">    result <span class="keyword">in</span> <span class="built_in">print</span>(result)</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">APIManager</span>.shared.requestHttpBinPostUrlEncoded(value: <span class="string">&quot;xxxx2&quot;</span>) &#123;</span><br><span class="line">    result <span class="keyword">in</span> <span class="built_in">print</span>(result)</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">APIManager</span>.shared.requestHttpBinPostJson(value: <span class="string">&quot;xxxx3&quot;</span>) &#123;</span><br><span class="line">    result <span class="keyword">in</span> <span class="built_in">print</span>(result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/pinkpika/APIRequestDesignDemo/tree/main/TestApp/APIRequestDesignVersion1">APIRequestDesignDemo - Version1</a></li>
</ul>
<hr>
<div class="note info flat"><p>🤔【 問題 】<br>實作每道 API 時都需要自行呼叫 Part1、Part2、Part3 不夠方便，很多時候都是相同流程卻要重複寫，希望有預設的流程，只需要定義請求的欄位和回應的物件就好。</p>
</div>

<hr>
<h1 id="Version2-：使用繼承和反射欄位"><a href="#Version2-：使用繼承和反射欄位" class="headerlink" title="[Version2]：使用繼承和反射欄位"></a>[Version2]：使用繼承和反射欄位</h1><h2 id="特性-1"><a href="#特性-1" class="headerlink" title="特性"></a>特性</h2><ul>
<li>使用 NetworkManager 封裝各種類型的請求方式</li>
<li>使用父類別 ( BaseRequest ) 和子類別繼承的特性<ul>
<li>定義請求通用的欄位 ex. Domain, Path, Method …. 等等，子類別可以自行修改</li>
<li>定義 send 方法實作 Part1、Part2、Part3，並呼叫 NetworkManager，子類別可以直接呼叫</li>
</ul>
</li>
<li>使用”反射欄位”來組合參數<ul>
<li>ex. get query, post body …. 等等</li>
</ul>
</li>
</ul>
<img src="/pinkblog/2022/02/17/iOS-Web-API-%E8%A8%AD%E8%A8%88-Web-API-Design-in-iOS/2.png" class="" width="800">

<h2 id="實作範例-1"><a href="#實作範例-1" class="headerlink" title="實作範例"></a>實作範例</h2><div class="tabs" id="version2"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#version2-1">NetworkManager</button></li><li class="tab"><button type="button" data-href="#version2-2">BaseRequest</button></li><li class="tab"><button type="button" data-href="#version2-3">HttpBinBase</button></li><li class="tab"><button type="button" data-href="#version2-4">HttpBinGet</button></li><li class="tab"><button type="button" data-href="#version2-5">HttpBinPostUrlEncoded</button></li><li class="tab"><button type="button" data-href="#version2-6">HttpBinPostJson</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="version2-1"><p><a target="_blank" rel="noopener" href="https://github.com/pinkpika/APIRequestDesignDemo/blob/main/TestApp/APIRequestDesignVersion2/NetworkManager.swift">完整版 NetworkManager.swift</a></p>
<figure class="highlight swift"><figcaption><span>NetworkManager.swift</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Network 管理者</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NetworkManager</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> shared <span class="operator">=</span> <span class="type">NetworkManager</span>()</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">init</span>()</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 轉換參數</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">convertParameters</span>(<span class="params">parameters</span>: [<span class="params">String</span>: <span class="keyword">Any</span>])</span> -&gt; [<span class="type">String</span>: <span class="type">String</span>] &#123;</span><br><span class="line">        <span class="keyword">var</span> temp: [<span class="type">String</span>: <span class="type">String</span>] <span class="operator">=</span> [:]</span><br><span class="line">        <span class="keyword">for</span> one <span class="keyword">in</span> parameters&#123;</span><br><span class="line">            <span class="keyword">switch</span> one.value &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="keyword">is</span> <span class="type">String</span>, <span class="keyword">is</span> <span class="type">Int</span>, <span class="keyword">is</span> <span class="type">Double</span>, <span class="keyword">is</span> <span class="type">CustomStringConvertible</span>:</span><br><span class="line">                temp[one.key] <span class="operator">=</span> <span class="string">&quot;<span class="subst">\(one.value)</span>&quot;</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> temp</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 處理回應</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">handleResponse</span>&lt;<span class="type">T</span>: <span class="type">Decodable</span>&gt;(<span class="params">data</span>: <span class="type">Data</span>?, <span class="params">response</span>: <span class="type">URLResponse</span>?, <span class="params">error</span>: <span class="type">Error</span>?, <span class="params">completion</span>: <span class="keyword">@escaping</span> ((<span class="type">Result</span>&lt;<span class="type">T</span>,<span class="type">NetworkManagerError</span>&gt;) -&gt; <span class="type">Void</span>))</span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: - 錯誤物件</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">NetworkManager</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 錯誤物件</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">NetworkManagerError</span>: <span class="title">Error</span></span>&#123;</span><br><span class="line">        <span class="keyword">case</span> requestError(error: <span class="type">Error</span>)</span><br><span class="line">        <span class="keyword">case</span> nilData</span><br><span class="line">        <span class="keyword">case</span> decodeError</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: - Get 相關請求</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">NetworkManager</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 發送 Get 請求</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">sendGetRequest</span>&lt;<span class="type">T</span>: <span class="type">Decodable</span>&gt;(<span class="operator">...</span>)</span> -&gt; <span class="type">URLSessionDataTask</span>?&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: - Post 相關請求</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">NetworkManager</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 發送 Post UrlEncoded 請求</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">sendPostUrlEncodedRequest</span>&lt;<span class="type">T</span>: <span class="type">Decodable</span>&gt;(<span class="operator">...</span>)</span> -&gt; <span class="type">URLSessionDataTask</span>?&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 發送 Post JSON 請求</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">sendPostJSONRequest</span>&lt;<span class="type">T</span>: <span class="type">Decodable</span>&gt;(<span class="operator">...</span>)</span> -&gt; <span class="type">Void</span>)) -&gt; <span class="type">URLSessionDataTask</span>?&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version2-2"><figure class="highlight swift"><figcaption><span>BaseRequest.swift</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseRequest</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Domain</span></span><br><span class="line">    <span class="keyword">var</span> domain: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Path</span></span><br><span class="line">    <span class="keyword">var</span> path: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 請求方法</span></span><br><span class="line">    <span class="keyword">var</span> method: <span class="type">HttpMethod</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> .get</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 內容格式</span></span><br><span class="line">    <span class="keyword">var</span> contentType: <span class="type">ContentType</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> .none</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Timeout</span></span><br><span class="line">    <span class="keyword">var</span> timeoutInterval: <span class="type">TimeInterval</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">60</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 發送請求</span></span><br><span class="line">    <span class="keyword">@discardableResult</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">send</span>&lt;<span class="type">T</span>: <span class="type">Decodable</span>&gt;(<span class="params">completion</span>: <span class="keyword">@escaping</span> ((<span class="type">Result</span>&lt;<span class="type">T</span>,<span class="type">NetworkManager</span>.<span class="type">NetworkManagerError</span>&gt;) -&gt; <span class="type">Void</span>))</span> -&gt; <span class="type">URLSessionDataTask</span>? &#123;</span><br><span class="line">        <span class="keyword">let</span> urlString <span class="operator">=</span> domain <span class="operator">+</span> path</span><br><span class="line">        <span class="keyword">switch</span> method &#123;</span><br><span class="line">        <span class="keyword">case</span> .get:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">NetworkManager</span>.shared.sendGetRequest(urlString: urlString, queryItems: getParameters(), timeoutInterval: timeoutInterval, completion: completion)</span><br><span class="line">        <span class="keyword">case</span> .post <span class="keyword">where</span> contentType <span class="operator">==</span> .urlencoded:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">NetworkManager</span>.shared.sendPostUrlEncodedRequest(urlString: urlString, urlEncodedParas: getParameters(), timeoutInterval: timeoutInterval, completion: completion)</span><br><span class="line">        <span class="keyword">case</span> .post <span class="keyword">where</span> contentType <span class="operator">==</span> .json:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">NetworkManager</span>.shared.sendPostJSONRequest(urlString: urlString, parameters: getParameters(), timeoutInterval: timeoutInterval, completion: completion)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 取得參數</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">getParameters</span>()</span> -&gt; [<span class="type">String</span>: <span class="keyword">Any</span>] &#123;</span><br><span class="line">        <span class="keyword">return</span> getParameters(mirror: <span class="type">Mirror</span>(reflecting: <span class="keyword">self</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 取得參數(使用Mirror所有父類別的參數，並轉換為Dictionary)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">getParameters</span>(<span class="params">mirror</span>: <span class="type">Mirror</span>)</span> -&gt; [<span class="type">String</span>: <span class="keyword">Any</span>] &#123;</span><br><span class="line">        <span class="keyword">var</span> parameters: [<span class="type">String</span>: <span class="keyword">Any</span>] <span class="operator">=</span> [:]</span><br><span class="line">        <span class="keyword">if</span> mirror.superclassMirror <span class="operator">!=</span> <span class="literal">nil</span> &#123;</span><br><span class="line">            parameters <span class="operator">=</span> parameters.merging(getParameters(mirror: mirror.superclassMirror<span class="operator">!</span> ))&#123; <span class="variable">$1</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> attr <span class="keyword">in</span> mirror.children &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> propertyName <span class="operator">=</span> attr.label &#123;</span><br><span class="line">                parameters[propertyName] <span class="operator">=</span> attr.value</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> parameters</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">BaseRequest</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">ContentType</span></span>&#123;</span><br><span class="line">        <span class="keyword">case</span> none</span><br><span class="line">        <span class="keyword">case</span> urlencoded</span><br><span class="line">        <span class="keyword">case</span> json</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">HttpMethod</span></span>&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">get</span></span><br><span class="line">        <span class="keyword">case</span> post</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version2-3"><figure class="highlight swift"><figcaption><span>HttpBinBaseRequest.swift</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpBinBaseRequest</span>: <span class="title">BaseRequest</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Domain</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> domain: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;https://httpbin.org/&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version2-4"><figure class="highlight swift"><figcaption><span>HttpBinGetRequest+Response.swift</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpBinGetRequest</span>: <span class="title">HttpBinBaseRequest</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> path: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;get&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> value: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;abc&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">setData</span>(<span class="params">value</span>: <span class="type">String</span>)</span> -&gt; <span class="keyword">Self</span>&#123;</span><br><span class="line">        <span class="keyword">self</span>.value <span class="operator">=</span> value</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HttpBinGetResponse</span>: <span class="title">Codable</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Args</span>: <span class="title">Codable</span></span>&#123;</span><br><span class="line">        <span class="keyword">let</span> value: <span class="type">String</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> args: <span class="type">Args</span></span><br><span class="line">    <span class="keyword">let</span> origin: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> url: <span class="type">String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version2-5"><figure class="highlight swift"><figcaption><span>HttpBinPostUrlEncodedRequest+Response.swift</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpBinPostUrlEncodedRequest</span>: <span class="title">HttpBinBaseRequest</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> path: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;post&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> method: <span class="type">HttpMethod</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> .post</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> contentType: <span class="type">ContentType</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> .urlencoded</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> value: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;我是資料&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">setData</span>(<span class="params">value</span>: <span class="type">String</span>)</span> -&gt; <span class="keyword">Self</span>&#123;</span><br><span class="line">        <span class="keyword">self</span>.value <span class="operator">=</span> value</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HttpBinPostJsonResponse</span>: <span class="title">Codable</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">JsonData</span>: <span class="title">Codable</span></span>&#123;</span><br><span class="line">        <span class="keyword">let</span> value: <span class="type">String</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> json: <span class="type">JsonData</span></span><br><span class="line">    <span class="keyword">let</span> origin: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> url: <span class="type">String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version2-6"><figure class="highlight swift"><figcaption><span>HttpBinPostJsonRequest+Response.swift</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpBinPostUrlEncodedRequest</span>: <span class="title">HttpBinBaseRequest</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> path: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;post&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> method: <span class="type">HttpMethod</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> .post</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> contentType: <span class="type">ContentType</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> .urlencoded</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> value: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;我是資料&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">setData</span>(<span class="params">value</span>: <span class="type">String</span>)</span> -&gt; <span class="keyword">Self</span>&#123;</span><br><span class="line">        <span class="keyword">self</span>.value <span class="operator">=</span> value</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HttpBinPostJsonResponse</span>: <span class="title">Codable</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">JsonData</span>: <span class="title">Codable</span></span>&#123;</span><br><span class="line">        <span class="keyword">let</span> value: <span class="type">String</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> json: <span class="type">JsonData</span></span><br><span class="line">    <span class="keyword">let</span> origin: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> url: <span class="type">String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>

<h2 id="使用方式-1"><a href="#使用方式-1" class="headerlink" title="使用方式"></a>使用方式</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HttpBinGetRequest</span>().setData(value: <span class="string">&quot;wwww1&quot;</span>).send &#123;</span><br><span class="line">    (result: <span class="type">Result</span>&lt;<span class="type">HttpBinGetResponse</span>,<span class="type">NetworkManager</span>.<span class="type">NetworkManagerError</span>&gt;) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">HttpBinPostUrlEncodedRequest</span>().setData(value: <span class="string">&quot;wwww2&quot;</span>).send &#123;</span><br><span class="line">    (result: <span class="type">Result</span>&lt;<span class="type">HttpBinPostUrlEncodedResponse</span>,<span class="type">NetworkManager</span>.<span class="type">NetworkManagerError</span>&gt;) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">HttpBinPostJsonRequest</span>().setData(value: <span class="string">&quot;wwww3&quot;</span>).send &#123;</span><br><span class="line">    (result: <span class="type">Result</span>&lt;<span class="type">HttpBinPostJsonResponse</span>,<span class="type">NetworkManager</span>.<span class="type">NetworkManagerError</span>&gt;) <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Demo-1"><a href="#Demo-1" class="headerlink" title="Demo"></a>Demo</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/pinkpika/APIRequestDesignDemo/tree/main/TestApp/APIRequestDesignVersion2">APIRequestDesignDemo - Version2</a></li>
</ul>
<hr>
<div class="note info flat"><p>🤔【 問題 】<br>雖然建立 API 物件變得非常快速看似美好，但面對各種不同站台的需求，還有當初面對多達 40 幾隻 App 使用這套系統，NetworkManager 因應不同參數或預設值不斷地擴大請求方法，有時還需要不同設定值的 URLSession，BaseRequest 也開始新增不同子類別和子流程(有無身份驗證/有無特定Header/有無Log/不同處理回應的方式…)，有些特殊的 API 還會需要同時塞 query 加上 body，甚至需要新增各種 Bool 開關或是 Delegate 的通知接口。<br>第一次體驗到如此深刻的”繼承税”…😭😭😭</p>
</div>

<div class="note primary flat"><p>繼承税這個詞是我從「 <a target="_blank" rel="noopener" href="https://www.tenlong.com.tw/products/9789865022754">The Pragmatic Programmer 20週年紀念版</a> 」看到的，書本引用一句話 “您只想要一根香蕉，但是您得到的卻是一隻拿著香蕉的大猩猩和整個叢林 - Joe Armstrong” 。</p>
<p>繼承就是一種耦合，父類別和子類別之間耦合、子類別新方法呼叫到父類別也是耦合，時間一久往往會迭代出多個類別的依賴關係，像是一個網狀一樣，修改需要小心影響上下功能；如果想要避免就是不要使用繼承，改用下列方式，詳情可以參考該書。</p>
<ul>
<li>interface/protocol </li>
<li>delegation </li>
<li>mixin/trait</li>
</ul>
</div>

<hr>
<div class="note success flat"><p>幸運的是正好看到 <a target="_blank" rel="noopener" href="https://twitter.com/onevcat">onevcat</a> 大神在 iPlayground 2019 分享了 <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Xk4HZfW6vK0">部件化網路程式設計</a> / <a target="_blank" rel="noopener" href="https://hackmd.io/@iPlayground/2019/%2FUBGbW1PVSl69rpE2h38w7A">hackmd共筆</a> / <a target="_blank" rel="noopener" href="https://github.com/onevcat/ComponentNetworking">ComponentNetworking Demo</a>，基本上可以達到每一道 API 抽換各種流程並且共用邏輯，甚至也可以進行單元測試或 Mock 資料；其中用部件並且”組合”出功能的概念頁也讓我想到 SwiftLee 這篇 <a target="_blank" rel="noopener" href="https://www.avanderlee.com/swift/composition-inheritance-code-architecture/">Composition vs. Inheritance</a>。</p>
</div>

<hr>
<h1 id="Version3-：使用部件化設計"><a href="#Version3-：使用部件化設計" class="headerlink" title="[Version3]：使用部件化設計"></a>[Version3]：使用部件化設計</h1><p><strong>此版本是從上面提到 onevcat 大神分享的作法 fork 做修改，並且因為我遇到的需求做調整，所以不會是最完美最適合你的，但是部件化的概念很適合給大家來進行調整。</strong></p>
<h2 id="特性-2"><a href="#特性-2" class="headerlink" title="特性"></a>特性</h2><ul>
<li>Part1 組合 Request: <ul>
<li>使用 Adapter 組裝一個一個的部件，可以是新增一個 Header、也可以是新增 Token</li>
<li>每經過一個部件會回傳修改後的 URLRequest，會把所有 Adapter 都執行過一遍後回傳最終的 URLRequest</li>
</ul>
</li>
<li>Part2 發送 API: <ul>
<li>使用 protocol ApiComponentSendable 先預設定義一種發送流程，並且可抽換發送主體(Native/Alamofire/Mock都可)</li>
</ul>
</li>
<li>Part3 處理 Response: <ul>
<li>使用 Decision 一個一個決策決定該做什麼，例如接續決策、重頭開始、發生錯誤、結束決策</li>
<li>如果是”接續決策”就往下一個決策判斷</li>
<li>如果到最後還是沒有”結束決策”或是”發生錯誤”，就代表決策設定有問題</li>
</ul>
</li>
<li>在定義 Request 中使用 RequestBaseSetting 方便抽換基底設定(正式或測試機)</li>
<li>在處理 Response 中使用 DecisionRecord 可以在 Console 清楚顯示決策流程</li>
<li>之前接過特殊站台當回應成功時，statusCode = 200 但 Data 為空的，所以範例有個 NilDataDecision、NilDataResponse 可使用</li>
</ul>
<img src="/pinkblog/2022/02/17/iOS-Web-API-%E8%A8%AD%E8%A8%88-Web-API-Design-in-iOS/3.png" class="" width="700">

<h2 id="實作範例-2"><a href="#實作範例-2" class="headerlink" title="實作範例"></a>實作範例</h2><p>下面只列出重要的物件，完整範例可以參考下面 Demo 網址！</p>
<div class="tabs" id="version3"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#version3-1">Request</button></li><li class="tab"><button type="button" data-href="#version3-2">ApiComponentSendable</button></li><li class="tab"><button type="button" data-href="#version3-3">Adapter</button></li><li class="tab"><button type="button" data-href="#version3-4">Decision</button></li><li class="tab"><button type="button" data-href="#version3-5">GetRequest</button></li><li class="tab"><button type="button" data-href="#version3-6">HttpBinService</button></li><li class="tab"><button type="button" data-href="#version3-7">HttpBinService+HttpBinGet</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="version3-1"><p>Request 定義 Api 的 基礎設定(domain)、HTTPMethod、轉接器、決策路徑。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Request基礎設定</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">RequestBaseSetting</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Domain</span></span><br><span class="line">    <span class="keyword">var</span> domain: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 基底Request</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 基底Response</span></span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">Response</span>: <span class="type">Decodable</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Request基礎設定</span></span><br><span class="line">    <span class="keyword">var</span> setting: <span class="type">RequestBaseSetting</span> &#123; <span class="keyword">get</span> <span class="keyword">set</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// HTTPMethod</span></span><br><span class="line">    <span class="keyword">var</span> method: <span class="type">HTTPMethod</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 請求轉接器(發送前處理)</span></span><br><span class="line">    <span class="keyword">var</span> adapters: [<span class="type">RequestAdapter</span>] &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 決策路徑(接收回應後處理)</span></span><br><span class="line">    <span class="keyword">var</span> decisions: [<span class="type">Decision</span>] &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/// 基底Request</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 建立Request</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">buildRequest</span>()</span> <span class="keyword">throws</span> -&gt; <span class="type">URLRequest</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: setting.domain) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="type">ApiComponentError</span>.requestAdapterFailure(error: <span class="literal">nil</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> request <span class="operator">=</span> <span class="type">URLRequest</span>(url: url)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> adapters.reduce(request) &#123; <span class="keyword">try</span> <span class="variable">$1</span>.adapted(<span class="variable">$0</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version3-2"><p>ApiComponentSendable 定義發送流程，包含 Part1 + Part2 + Part3，每個部分都是被組裝而成。<br><a target="_blank" rel="noopener" href="https://github.com/pinkpika/APIRequestDesignDemo/blob/main/TestApp/APIRequestDesignVersion3/Component/ApiComponentSendable.swift">完整版 ApiComponentSendable.swift</a></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">ApiComponentSendable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">sendRequest</span>(<span class="params">request</span>: <span class="type">URLRequest</span>, <span class="params">queue</span>: <span class="type">DispatchQueue</span>, <span class="params">handler</span>: <span class="keyword">@escaping</span> (<span class="type">Data</span>?, <span class="type">URLResponse</span>?, <span class="type">Error</span>?) -&gt; <span class="type">Void</span>)</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ApiComponentSendable</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 發送Request(使用初始決策)</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">send</span>&lt;<span class="type">Req</span>: <span class="type">Request</span>&gt;(</span></span><br><span class="line"><span class="function">        <span class="params">request</span>: <span class="type">Req</span>,</span></span><br><span class="line"><span class="function">        <span class="params">queue</span>: <span class="type">DispatchQueue</span>,</span></span><br><span class="line"><span class="function">        <span class="params">handler</span>: <span class="keyword">@escaping</span> (<span class="type">Swift</span>.<span class="type">Result</span>&lt;<span class="type">Req</span>.<span class="type">Response</span>, <span class="type">Error</span>&gt;) -&gt; <span class="type">Void</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        send(request: request,</span><br><span class="line">             decisions: request.decisions,</span><br><span class="line">             queue: queue,</span><br><span class="line">             handler: handler)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 發送Request(使用特定決策)</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">send</span>&lt;<span class="type">Req</span>: <span class="type">Request</span>&gt;(</span></span><br><span class="line"><span class="function">        <span class="params">request</span>: <span class="type">Req</span>,</span></span><br><span class="line"><span class="function">        <span class="params">decisions</span>: [<span class="type">Decision</span>],</span></span><br><span class="line"><span class="function">        <span class="params">queue</span>: <span class="type">DispatchQueue</span>,</span></span><br><span class="line"><span class="function">        <span class="params">handler</span>: <span class="keyword">@escaping</span> (<span class="type">Swift</span>.<span class="type">Result</span>&lt;<span class="type">Req</span>.<span class="type">Response</span>, <span class="type">Error</span>&gt;) -&gt; <span class="type">Void</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Todo: 建立Request</span></span><br><span class="line">        request.buildRequest</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Todo: 發送 Request</span></span><br><span class="line">        sendRequest(request: urlRequest, queue: queue)&#123;</span><br><span class="line">            (data, response, error) <span class="keyword">in</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Todo: - 預設處理 data, response, error</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Todo: - 處理決策</span></span><br><span class="line">            <span class="keyword">self</span>.handleDecision(</span><br><span class="line">                request: request,</span><br><span class="line">                queue: queue,</span><br><span class="line">                data: data,</span><br><span class="line">                response: httpResponse,</span><br><span class="line">                nowDecisions: decisions,</span><br><span class="line">                decisionRecords: [],</span><br><span class="line">                handler: handler</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 處理決策</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">handleDecision</span>&lt;<span class="type">Req</span>: <span class="type">Request</span>&gt;(</span></span><br><span class="line"><span class="function">        <span class="params">request</span>: <span class="type">Req</span>,</span></span><br><span class="line"><span class="function">        <span class="params">queue</span>: <span class="type">DispatchQueue</span>,</span></span><br><span class="line"><span class="function">        <span class="params">data</span>: <span class="type">Data</span>?,</span></span><br><span class="line"><span class="function">        <span class="params">response</span>: <span class="type">HTTPURLResponse</span>,</span></span><br><span class="line"><span class="function">        <span class="params">nowDecisions</span>: [<span class="type">Decision</span>],</span></span><br><span class="line"><span class="function">        <span class="params">decisionRecords</span>: [<span class="type">DecisionRecord</span>&lt;<span class="type">Req</span>&gt;],</span></span><br><span class="line"><span class="function">        <span class="params">handler</span>: <span class="keyword">@escaping</span> (<span class="type">Swift</span>.<span class="type">Result</span>&lt;<span class="type">Req</span>.<span class="type">Response</span>, <span class="type">Error</span>&gt;) -&gt; <span class="type">Void</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Todo: - 判斷是否應用決策</span></span><br><span class="line">        <span class="keyword">var</span> nowDecisions <span class="operator">=</span> nowDecisions</span><br><span class="line">        <span class="keyword">let</span> current <span class="operator">=</span> nowDecisions.removeFirst()</span><br><span class="line">        current.shouldApply <span class="operator">...</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Todo: - 執行決策</span></span><br><span class="line">        current.apply(request: request, data: data, response: response) &#123; action <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 判斷 action</span></span><br><span class="line">                <span class="comment">// Todo: 1 繼續執行</span></span><br><span class="line">                handleDecision</span><br><span class="line">                <span class="comment">// Todo: 2 重新開始    </span></span><br><span class="line">                send(<span class="operator">...</span>)發送<span class="type">Request</span>(使用特定決策)</span><br><span class="line">                <span class="comment">// Todo: 3 發生錯誤</span></span><br><span class="line">                handler(.failure(error))</span><br><span class="line">                <span class="comment">// Todo: 4 完成決策</span></span><br><span class="line">                handler(.success(response))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version3-3"><p>Adapter 就是用來組裝 Request 的各種部件，可以組合 Header 或是 body 都可以。</p>
<figure class="highlight swift"><figcaption><span>Adapter</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 請求轉接器</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">RequestAdapter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">adapted</span>(<span class="keyword">_</span> <span class="params">request</span>: <span class="type">URLRequest</span>)</span> <span class="keyword">throws</span> -&gt; <span class="type">URLRequest</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// HTTPMethod 的 轉接器</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HTTPMethodAdapter</span>: <span class="title">RequestAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> method: <span class="type">HTTPMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">adapted</span>(<span class="keyword">_</span> <span class="params">request</span>: <span class="type">URLRequest</span>)</span> <span class="keyword">throws</span> -&gt; <span class="type">URLRequest</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> request <span class="operator">=</span> request</span><br><span class="line">        request.httpMethod <span class="operator">=</span> method.rawValue</span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// ContentType 的 轉接器</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentTypeAdapter</span>: <span class="title">RequestAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> contentType: <span class="type">ContentType</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">adapted</span>(<span class="keyword">_</span> <span class="params">request</span>: <span class="type">URLRequest</span>)</span> <span class="keyword">throws</span> -&gt; <span class="type">URLRequest</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> request <span class="operator">=</span> request</span><br><span class="line">        request.setValue(contentType.rawValue, forHTTPHeaderField: <span class="string">&quot;Content-Type&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version3-4"><p>Decision 有兩種方法 shouldApply 和 apply，當 shouldApply 為 true 的時候才會執行 apply。<br>apply 記得要執行任一種 DecisionAction 才會順利執行。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 決策方式</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Decision</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 是否要應用</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">shouldApply</span>&lt;<span class="type">Req</span>: <span class="type">Request</span>&gt;(<span class="params">request</span>: <span class="type">Req</span>, <span class="params">data</span>: <span class="type">Data</span>?, <span class="params">response</span>: <span class="type">HTTPURLResponse</span>)</span> -&gt; <span class="type">Bool</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 應用方式</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">apply</span>&lt;<span class="type">Req</span>: <span class="type">Request</span>&gt;(</span></span><br><span class="line"><span class="function">        <span class="params">request</span>: <span class="type">Req</span>,</span></span><br><span class="line"><span class="function">        <span class="params">data</span>: <span class="type">Data</span>?,</span></span><br><span class="line"><span class="function">        <span class="params">response</span>: <span class="type">HTTPURLResponse</span>,</span></span><br><span class="line"><span class="function">        <span class="params">done</span> <span class="params">closure</span>: <span class="keyword">@escaping</span> (<span class="type">DecisionAction</span>&lt;<span class="type">Req</span>&gt;) -&gt; <span class="type">Void</span>)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 決策動作</span></span><br><span class="line"><span class="comment">/// - continueWith: 接續決策</span></span><br><span class="line"><span class="comment">/// - restartWith: 重頭開始</span></span><br><span class="line"><span class="comment">/// - errored: 發生錯誤</span></span><br><span class="line"><span class="comment">/// - done: 結束決策</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">DecisionAction</span>&lt;<span class="title">Req</span>: <span class="title">Request</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> continueWith(<span class="type">Data</span>?, <span class="type">HTTPURLResponse</span>)</span><br><span class="line">    <span class="keyword">case</span> restartWith([<span class="type">Decision</span>])</span><br><span class="line">    <span class="keyword">case</span> errored(<span class="type">Error</span>)</span><br><span class="line">    <span class="keyword">case</span> done(<span class="type">Req</span>.<span class="type">Response</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 決策方式 - 錯誤狀態碼</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BadStatusCodeDecision</span>: <span class="title">Decision</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">shouldApply</span>&lt;<span class="type">Req</span>: <span class="type">Request</span>&gt;(<span class="params">request</span>: <span class="type">Req</span>, <span class="params">data</span>: <span class="type">Data</span>?, <span class="params">response</span>: <span class="type">HTTPURLResponse</span>)</span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="operator">!</span>(<span class="number">200</span><span class="operator">..&lt;</span><span class="number">300</span>).contains(response.statusCode)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">apply</span>&lt;<span class="type">Req</span>: <span class="type">Request</span>&gt;(</span></span><br><span class="line"><span class="function">        <span class="params">request</span>: <span class="type">Req</span>,</span></span><br><span class="line"><span class="function">        <span class="params">data</span>: <span class="type">Data</span>?,</span></span><br><span class="line"><span class="function">        <span class="params">response</span>: <span class="type">HTTPURLResponse</span>,</span></span><br><span class="line"><span class="function">        <span class="params">done</span> <span class="params">closure</span>: <span class="keyword">@escaping</span> (<span class="type">DecisionAction</span>&lt;<span class="type">Req</span>&gt;) -&gt; <span class="type">Void</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        closure(.errored(<span class="type">ApiComponentError</span>.badStatusCode(data: data, statusCode: response.statusCode)))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 決策方式 - 轉換物件</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ParseResultDecision</span>: <span class="title">Decision</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">shouldApply</span>&lt;<span class="type">Req</span>: <span class="type">Request</span>&gt;(<span class="params">request</span>: <span class="type">Req</span>, <span class="params">data</span>: <span class="type">Data</span>?, <span class="params">response</span>: <span class="type">HTTPURLResponse</span>)</span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">apply</span>&lt;<span class="type">Req</span>: <span class="type">Request</span>&gt;(</span></span><br><span class="line"><span class="function">        <span class="params">request</span>: <span class="type">Req</span>,</span></span><br><span class="line"><span class="function">        <span class="params">data</span>: <span class="type">Data</span>?,</span></span><br><span class="line"><span class="function">        <span class="params">response</span>: <span class="type">HTTPURLResponse</span>,</span></span><br><span class="line"><span class="function">        <span class="params">done</span> <span class="params">closure</span>: <span class="keyword">@escaping</span> (<span class="type">DecisionAction</span>&lt;<span class="type">Req</span>&gt;) -&gt; <span class="type">Void</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> data <span class="operator">=</span> data <span class="keyword">else</span> &#123;</span><br><span class="line">            closure(.errored(<span class="type">ApiComponentError</span>.nilData))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> value <span class="operator">=</span> <span class="keyword">try</span> <span class="type">JSONDecoder</span>().decode(<span class="type">Req</span>.<span class="type">Response</span>.<span class="keyword">self</span>, from: data)</span><br><span class="line">            closure(.done(value))</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            closure(.errored(<span class="type">ApiComponentError</span>.decodeFailure(data: data, error: error)))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version3-5"><p>GetRequest conform Request，並且實作預設的 method、adapters、decisions。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 基底Request - Get</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">GetRequest</span>: <span class="title">Request</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Path</span></span><br><span class="line">    <span class="keyword">var</span> path: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Query Params</span></span><br><span class="line">    <span class="keyword">var</span> queryParams: [<span class="type">String</span>: <span class="type">String</span>]<span class="operator">?</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 基底Request - Get</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">GetRequest</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> method: <span class="type">HTTPMethod</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> .get</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 預設的轉接器</span></span><br><span class="line">    <span class="keyword">var</span> adapters: [<span class="type">RequestAdapter</span>] &#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="type">PathAdapter</span>(path: path),</span><br><span class="line">            <span class="type">HTTPMethodAdapter</span>(method: method),</span><br><span class="line">            <span class="type">QueryParamsAdapter</span>(queryParams: queryParams)</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 預設的決策路徑</span></span><br><span class="line">    <span class="keyword">var</span> decisions: [<span class="type">Decision</span>] &#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="type">BadStatusCodeDecision</span>(),</span><br><span class="line">            <span class="type">ParseResultDecision</span>()</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version3-6"><p>HttpBinService 用來放該站台的 Request、Response、預設的設定值。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// HttpBinService ( https://httpbin.org/#/HTTP_Methods )</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HttpBinService</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 預設設定值</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> defaultSetting: <span class="type">HttpBinServiceSetting</span> <span class="operator">=</span> .<span class="keyword">init</span>(status: .production)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// HttpBinServiceSetting</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HttpBinServiceSetting</span>: <span class="title">RequestBaseSetting</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 狀態(通常站台會有正式站和測試站，但也有可能更多)</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">Status</span>: <span class="title">String</span></span>&#123;</span><br><span class="line">        <span class="keyword">case</span> debug <span class="operator">=</span> <span class="string">&quot;https://httpbin.debug.org&quot;</span></span><br><span class="line">        <span class="keyword">case</span> production <span class="operator">=</span> <span class="string">&quot;https://httpbin.org&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> status: <span class="type">Status</span></span><br><span class="line">    <span class="keyword">var</span> domain: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> status.rawValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version3-7"><p>HttpBinGetRequest conform GetRequest，只要定義所需欄位就行！</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">HttpBinService</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HttpBinGetRequest</span>: <span class="title">GetRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">typealias</span> <span class="type">Response</span> <span class="operator">=</span> <span class="type">HttpBinGetResponse</span></span><br><span class="line">        <span class="keyword">var</span> setting: <span class="type">RequestBaseSetting</span> <span class="operator">=</span> defaultSetting</span><br><span class="line">        <span class="keyword">var</span> path: <span class="type">String</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;/get&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> queryParams: [<span class="type">String</span> : <span class="type">String</span>]<span class="operator">?</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> [<span class="string">&quot;foo&quot;</span>: foo]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> foo: <span class="type">String</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HttpBinGetResponse</span>: <span class="title">Codable</span> </span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Args</span>: <span class="title">Codable</span> </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> foo: <span class="type">String</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> args: <span class="type">Args</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>

<h2 id="使用方式-2"><a href="#使用方式-2" class="headerlink" title="使用方式"></a>使用方式</h2><div class="tabs" id="version3demo"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#version3demo-1">基本用法</button></li><li class="tab"><button type="button" data-href="#version3demo-2">Mock測試</button></li><li class="tab"><button type="button" data-href="#version3demo-3">切換正式或測試環境</button></li><li class="tab"><button type="button" data-href="#version3demo-4">完全客製化Request</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="version3demo-1"><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> request1 <span class="operator">=</span> <span class="type">HttpBinService</span>.<span class="type">HttpBinGetRequest</span>(foo: <span class="string">&quot;123&quot;</span>)</span><br><span class="line"><span class="type">ApiNativeClient</span>(session: .shared).send(request: request1, queue: .main) &#123;</span><br><span class="line">    result <span class="keyword">in</span> <span class="built_in">print</span>(result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">🌐 [HttpBinGetRequest][GET]: https://httpbin.org/get?foo=123</span><br><span class="line">⏰ [HttpBinGetRequest][ReceiveTime]: 0.416s - https://httpbin.org/get?foo=123</span><br><span class="line">📦 [HttpBinGetRequest][StatusCode = 200][ReceiveData]: ...</span><br><span class="line">🚥 [HttpBinGetRequest][Decisions]: &#123;BadStatusCode❕&#125; -&gt; &#123;ParseResult❗️&#125;[Success!!!🙆🙆🙆]</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version3demo-2"><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Case: 進行 Mock 的測試</span></span><br><span class="line"><span class="keyword">var</span> request <span class="operator">=</span> <span class="type">HttpBinService</span>.<span class="type">HttpBinGetRequest</span>(foo: <span class="string">&quot;0000&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> dataString <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&#123;&quot;args&quot;:&#123;&quot;foo&quot;:&quot;0000&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">let</span> apiMockClient <span class="operator">=</span> <span class="type">ApiMockClient</span>(data: dataString.data(using: .utf8), statusCode: <span class="number">200</span>)</span><br><span class="line">apiMockClient.send(request: request, queue: .main) &#123;</span><br><span class="line">    result <span class="keyword">in</span> <span class="built_in">print</span>(result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version3demo-3"><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Case: 整個站台切換正式或測試環境</span></span><br><span class="line"><span class="type">HttpBinService</span>.defaultSetting.status <span class="operator">=</span> .debug</span><br><span class="line"><span class="keyword">let</span> request <span class="operator">=</span> <span class="type">HttpBinService</span>.<span class="type">HttpBinGetRequest</span>(foo: <span class="string">&quot;123&quot;</span>)</span><br><span class="line"><span class="type">ApiNativeClient</span>(session: .shared).send(request: request, queue: .main) &#123;</span><br><span class="line">    result <span class="keyword">in</span> <span class="built_in">print</span>(result)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Case: 只切換一道 Api 正式或測試環境</span></span><br><span class="line"><span class="keyword">var</span> request <span class="operator">=</span> <span class="type">HttpBinService</span>.<span class="type">HttpBinGetRequest</span>(foo: <span class="string">&quot;123&quot;</span>)</span><br><span class="line">request.setting <span class="operator">=</span> <span class="type">HttpBinServiceSetting</span>.<span class="keyword">init</span>(status: .debug)</span><br><span class="line"><span class="type">ApiNativeClient</span>(session: .shared).send(request: request, queue: .main) &#123;</span><br><span class="line">    result <span class="keyword">in</span> <span class="built_in">print</span>(result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="version3demo-4"><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">HttpBinService</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HttpBinCustomRequest</span>: <span class="title">Request</span> </span>&#123;</span><br><span class="line">        <span class="keyword">typealias</span> <span class="type">Response</span> <span class="operator">=</span> <span class="type">HttpBinCustomResponse</span></span><br><span class="line">        <span class="keyword">var</span> setting: <span class="type">RequestBaseSetting</span> <span class="operator">=</span> defaultSetting</span><br><span class="line">        <span class="keyword">var</span> method: <span class="type">HTTPMethod</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> .get <span class="comment">// <span class="doctag">TODO:</span> - Method</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> adapters: [<span class="type">RequestAdapter</span>] &#123;</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> - 請求轉接器</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> decisions: [<span class="type">Decision</span>] &#123;</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> - 決策路徑</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HttpBinCustomResponse</span>: <span class="title">Codable</span> </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> - 回應物件</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>

<h2 id="Demo-2"><a href="#Demo-2" class="headerlink" title="Demo"></a>Demo</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/pinkpika/APIRequestDesignDemo/tree/main/TestApp/APIRequestDesignVersion3">APIRequestDesignDemo - Version3</a></li>
</ul>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/pinkblog/tags/iOS/">iOS</a><a class="post-meta__tags" href="/pinkblog/tags/Web-API/">Web API</a></div><div class="post_share"></div></div><iframe width="100%" height="230px" scrolling="no" frameborder="0" src="https://button.like.co/in/embed/tim801217/button/?referrer=&lt;%- post.permalink %&gt;"></iframe><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/pinkblog/2022/02/15/%E8%87%AA%E5%BB%BA%E7%AB%99%E5%8F%B0%E8%A7%A3%E6%B1%BA-CORS-Policy-%E5%95%8F%E9%A1%8C/"><img class="next-cover" src="/pinkblog/2022/02/15/%E8%87%AA%E5%BB%BA%E7%AB%99%E5%8F%B0%E8%A7%A3%E6%B1%BA-CORS-Policy-%E5%95%8F%E9%A1%8C/unsplash_kMdEgc_UNvg.jpg" onerror="onerror=null;src='/pinkblog/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">自建站台解決 CORS Policy 問題</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相關推薦</span></div><div class="relatedPosts-list"><div><a href="/pinkblog/2022/01/09/iOS-%E6%A8%A1%E7%B5%84%E5%8C%96%E6%9E%B6%E6%A7%8B-Modular-Architecture-in-iOS/" title="iOS 模組化架構 (Modular Architecture in iOS)"><img class="cover" src="/pinkblog/2022/01/09/iOS-%E6%A8%A1%E7%B5%84%E5%8C%96%E6%9E%B6%E6%A7%8B-Modular-Architecture-in-iOS/unsplash_L0oJ4Dlfyuo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 1月 9 2022</div><div class="title">iOS 模組化架構 (Modular Architecture in iOS)</div></div></a></div><div><a href="/pinkblog/2022/01/09/%E5%BB%BA%E7%AB%8B-Local-Podspec/" title="建立 Local Podspec"><img class="cover" src="/pinkblog/2022/01/09/%E5%BB%BA%E7%AB%8B-Local-Podspec/unsplash_ymf4_9Y9S_A.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 1月 9 2022</div><div class="title">建立 Local Podspec</div></div></a></div><div><a href="/pinkblog/2022/01/16/Podspec-%E5%85%A7%E4%BD%BF%E7%94%A8%E4%B8%89%E6%96%B9%E3%80%81Asset%E3%80%81Storyboard%E3%80%81Xib/" title="Podspec 內使用三方、Asset、Storyboard、Xib"><img class="cover" src="/pinkblog/2022/01/16/Podspec-%E5%85%A7%E4%BD%BF%E7%94%A8%E4%B8%89%E6%96%B9%E3%80%81Asset%E3%80%81Storyboard%E3%80%81Xib/unsplash_t5YUoHW6zRo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 1月 16 2022</div><div class="title">Podspec 內使用三方、Asset、Storyboard、Xib</div></div></a></div><div><a href="/pinkblog/2022/01/13/IBDesignable-%E5%92%8C-IBInspectable-%E7%9A%84%E5%8F%AF%E8%A6%96%E5%8C%96-View/" title="IBDesignable 和 IBInspectable 的可視化 View"><img class="cover" src="/pinkblog/2022/01/13/IBDesignable-%E5%92%8C-IBInspectable-%E7%9A%84%E5%8F%AF%E8%A6%96%E5%8C%96-View/unsplash_0Mg6zEBQs4s.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 1月 13 2022</div><div class="title">IBDesignable 和 IBInspectable 的可視化 View</div></div></a></div><div><a href="/pinkblog/2022/01/16/Podspec-%E8%AA%BF%E6%95%B4%E8%B3%87%E6%96%99%E5%A4%BE%E7%B5%90%E6%A7%8B/" title="Podspec 調整資料夾結構"><img class="cover" src="/pinkblog/2022/01/16/Podspec-%E8%AA%BF%E6%95%B4%E8%B3%87%E6%96%99%E5%A4%BE%E7%B5%90%E6%A7%8B/cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 1月 16 2022</div><div class="title">Podspec 調整資料夾結構</div></div></a></div><div><a href="/pinkblog/2022/01/26/DispatchQueue-%E7%9A%84%E7%B0%A1%E5%96%AE%E6%87%89%E7%94%A8/" title="DispatchQueue 的簡單應用"><img class="cover" src="/pinkblog/2022/01/26/DispatchQueue-%E7%9A%84%E7%B0%A1%E5%96%AE%E6%87%89%E7%94%A8/unsplash_nIEHqGSymRU.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 1月 26 2022</div><div class="title">DispatchQueue 的簡單應用</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 評論</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/pinkblog/img/avatar.jpg" onerror="this.onerror=null;this.src='/pinkblog/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">pinkpika</div><div class="author-info__description">Simplicity is the soul of efficiency.</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/pinkblog/archives/"><div class="headline">文章</div><div class="length-num">21</div></a></div><div class="card-info-data-item"><a href="/pinkblog/tags/"><div class="headline">標籤</div><div class="length-num">13</div></a></div><div class="card-info-data-item"><a href="/pinkblog/categories/"><div class="headline">分類</div><div class="length-num">6</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/pinkpika" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://twitter.com/pinkpika_coding" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a><a class="social-icon" href="https://www.linkedin.com/in/pink-pika-42907613a/" target="_blank" title="Linkedin"><i class="fab fa-linkedin-in"></i></a><a class="social-icon" href="mailto:tim801217@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">最近換了一個新主題 Butterfly，畫面優美有支援深淺模式，附帶的功能也很多。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目錄</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Web-API-%E8%A8%AD%E8%A8%88%E7%9A%84%E9%82%8F%E8%BC%AF"><span class="toc-number">1.</span> <span class="toc-text">Web API 設計的邏輯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%B5-Part1-%E7%B5%84%E5%90%88-Request-%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">🔵 Part1 組合 Request 流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%B4-Part2-%E7%99%BC%E9%80%81-API-%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">🔴 Part2 發送 API 流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9F%A2-Part3-%E8%99%95%E7%90%86-Response-%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.</span> <span class="toc-text">🟢 Part3 處理 Response 流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Version1-%EF%BC%9A%E4%BD%BF%E7%94%A8%E7%89%A9%E4%BB%B6%E5%92%8C%E6%96%B9%E6%B3%95%E5%B0%81%E8%A3%9D"><span class="toc-number">2.</span> <span class="toc-text">[Version1]：使用物件和方法封裝</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%80%A7"><span class="toc-number">2.1.</span> <span class="toc-text">特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%A6%E4%BD%9C%E7%AF%84%E4%BE%8B"><span class="toc-number">2.2.</span> <span class="toc-text">實作範例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">2.3.</span> <span class="toc-text">使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Demo"><span class="toc-number">2.4.</span> <span class="toc-text">Demo</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Version2-%EF%BC%9A%E4%BD%BF%E7%94%A8%E7%B9%BC%E6%89%BF%E5%92%8C%E5%8F%8D%E5%B0%84%E6%AC%84%E4%BD%8D"><span class="toc-number">3.</span> <span class="toc-text">[Version2]：使用繼承和反射欄位</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%80%A7-1"><span class="toc-number">3.1.</span> <span class="toc-text">特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%A6%E4%BD%9C%E7%AF%84%E4%BE%8B-1"><span class="toc-number">3.2.</span> <span class="toc-text">實作範例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-1"><span class="toc-number">3.3.</span> <span class="toc-text">使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Demo-1"><span class="toc-number">3.4.</span> <span class="toc-text">Demo</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Version3-%EF%BC%9A%E4%BD%BF%E7%94%A8%E9%83%A8%E4%BB%B6%E5%8C%96%E8%A8%AD%E8%A8%88"><span class="toc-number">4.</span> <span class="toc-text">[Version3]：使用部件化設計</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%80%A7-2"><span class="toc-number">4.1.</span> <span class="toc-text">特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%A6%E4%BD%9C%E7%AF%84%E4%BE%8B-2"><span class="toc-number">4.2.</span> <span class="toc-text">實作範例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-2"><span class="toc-number">4.3.</span> <span class="toc-text">使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Demo-2"><span class="toc-number">4.4.</span> <span class="toc-text">Demo</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/pinkblog/2022/02/17/iOS-Web-API-%E8%A8%AD%E8%A8%88-Web-API-Design-in-iOS/" title="iOS Web API 設計 (Web API Design in iOS)"><img src="/pinkblog/2022/02/17/iOS-Web-API-%E8%A8%AD%E8%A8%88-Web-API-Design-in-iOS/unsplash_ZiQkhI7417A.jpg" onerror="this.onerror=null;this.src='/pinkblog/img/404.jpg'" alt="iOS Web API 設計 (Web API Design in iOS)"/></a><div class="content"><a class="title" href="/pinkblog/2022/02/17/iOS-Web-API-%E8%A8%AD%E8%A8%88-Web-API-Design-in-iOS/" title="iOS Web API 設計 (Web API Design in iOS)">iOS Web API 設計 (Web API Design in iOS)</a><time datetime="2022-02-17T03:05:18.000Z" title="發表於 2月 17 2022 11:05:18">2月 17 2022</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/pinkblog/2022/02/15/%E8%87%AA%E5%BB%BA%E7%AB%99%E5%8F%B0%E8%A7%A3%E6%B1%BA-CORS-Policy-%E5%95%8F%E9%A1%8C/" title="自建站台解決 CORS Policy 問題"><img src="/pinkblog/2022/02/15/%E8%87%AA%E5%BB%BA%E7%AB%99%E5%8F%B0%E8%A7%A3%E6%B1%BA-CORS-Policy-%E5%95%8F%E9%A1%8C/unsplash_kMdEgc_UNvg.jpg" onerror="this.onerror=null;this.src='/pinkblog/img/404.jpg'" alt="自建站台解決 CORS Policy 問題"/></a><div class="content"><a class="title" href="/pinkblog/2022/02/15/%E8%87%AA%E5%BB%BA%E7%AB%99%E5%8F%B0%E8%A7%A3%E6%B1%BA-CORS-Policy-%E5%95%8F%E9%A1%8C/" title="自建站台解決 CORS Policy 問題">自建站台解決 CORS Policy 問題</a><time datetime="2022-02-15T06:22:02.000Z" title="發表於 2月 15 2022 14:22:02">2月 15 2022</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/pinkblog/2022/02/06/XCTest-%E5%92%8C-Unit-Testing-Bundle/" title="XCTest 和 Unit Testing Bundle"><img src="/pinkblog/2022/02/06/XCTest-%E5%92%8C-Unit-Testing-Bundle/unsplash_d9ILr-dbEdg.jpg" onerror="this.onerror=null;this.src='/pinkblog/img/404.jpg'" alt="XCTest 和 Unit Testing Bundle"/></a><div class="content"><a class="title" href="/pinkblog/2022/02/06/XCTest-%E5%92%8C-Unit-Testing-Bundle/" title="XCTest 和 Unit Testing Bundle">XCTest 和 Unit Testing Bundle</a><time datetime="2022-02-06T08:15:10.000Z" title="發表於 2月 6 2022 16:15:10">2月 6 2022</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/pinkblog/2022/02/06/Unit-Testing-%E7%9A%84%E5%85%A5%E9%96%80%E4%BB%8B%E7%B4%B9/" title="Unit Testing 的入門介紹"><img src="/pinkblog/2022/02/06/Unit-Testing-%E7%9A%84%E5%85%A5%E9%96%80%E4%BB%8B%E7%B4%B9/unsplash_d9ILr-dbEdg.jpg" onerror="this.onerror=null;this.src='/pinkblog/img/404.jpg'" alt="Unit Testing 的入門介紹"/></a><div class="content"><a class="title" href="/pinkblog/2022/02/06/Unit-Testing-%E7%9A%84%E5%85%A5%E9%96%80%E4%BB%8B%E7%B4%B9/" title="Unit Testing 的入門介紹">Unit Testing 的入門介紹</a><time datetime="2022-02-06T05:56:37.000Z" title="發表於 2月 6 2022 13:56:37">2月 6 2022</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/pinkblog/2022/02/01/SwiftLint-%E9%9D%9C%E6%85%8B%E6%AA%A2%E6%9F%A5%E5%99%A8/" title="SwiftLint 靜態檢查器"><img src="/pinkblog/2022/02/01/SwiftLint-%E9%9D%9C%E6%85%8B%E6%AA%A2%E6%9F%A5%E5%99%A8/unsplash_dlxLGIy-2VU.jpg" onerror="this.onerror=null;this.src='/pinkblog/img/404.jpg'" alt="SwiftLint 靜態檢查器"/></a><div class="content"><a class="title" href="/pinkblog/2022/02/01/SwiftLint-%E9%9D%9C%E6%85%8B%E6%AA%A2%E6%9F%A5%E5%99%A8/" title="SwiftLint 靜態檢查器">SwiftLint 靜態檢查器</a><time datetime="2022-02-01T05:40:55.000Z" title="發表於 2月 1 2022 13:40:55">2月 1 2022</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/pinkblog/2022/01/26/DispatchQueue-%E7%9A%84%E7%B0%A1%E5%96%AE%E6%87%89%E7%94%A8/" title="DispatchQueue 的簡單應用"><img src="/pinkblog/2022/01/26/DispatchQueue-%E7%9A%84%E7%B0%A1%E5%96%AE%E6%87%89%E7%94%A8/unsplash_nIEHqGSymRU.jpg" onerror="this.onerror=null;this.src='/pinkblog/img/404.jpg'" alt="DispatchQueue 的簡單應用"/></a><div class="content"><a class="title" href="/pinkblog/2022/01/26/DispatchQueue-%E7%9A%84%E7%B0%A1%E5%96%AE%E6%87%89%E7%94%A8/" title="DispatchQueue 的簡單應用">DispatchQueue 的簡單應用</a><time datetime="2022-01-26T06:23:27.000Z" title="發表於 1月 26 2022 14:23:27">1月 26 2022</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/pinkblog/2022/01/23/Hexo-RSS-Sitemap%E8%A8%AD%E5%AE%9A/" title="Hexo-RSS+Sitemap設定"><img src="/pinkblog/2022/01/23/Hexo-RSS-Sitemap%E8%A8%AD%E5%AE%9A/cover.png" onerror="this.onerror=null;this.src='/pinkblog/img/404.jpg'" alt="Hexo-RSS+Sitemap設定"/></a><div class="content"><a class="title" href="/pinkblog/2022/01/23/Hexo-RSS-Sitemap%E8%A8%AD%E5%AE%9A/" title="Hexo-RSS+Sitemap設定">Hexo-RSS+Sitemap設定</a><time datetime="2022-01-23T05:33:15.000Z" title="發表於 1月 23 2022 13:33:15">1月 23 2022</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By pinkpika</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主題 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="閱讀模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="淺色和深色模式轉換"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="單欄和雙欄切換"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="設定"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目錄"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直達評論"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到頂部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/pinkblog/js/utils.js"></script><script src="/pinkblog/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"><script>function loadGiscus () {
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'pinkpika/pinkblog_giscus',
    'data-repo-id': 'R_kgDOGuAMCw',
    'data-category-id': 'DIC_kwDOGuAMC84CAzt2',
    'data-mapping': 'pathname',
    'data-theme': nowTheme,
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme () {
  const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }

  sendMessage({
    setConfig: {
      theme: theme
    }
  });
}

if ('Giscus' === 'Giscus' || !false) {
  if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>